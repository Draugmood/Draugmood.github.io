name: Build Game with Pygbag and publish to GitHub pages
on:
  push:
    branches:
      - main
    paths:
      - 'app1/**'
      - '.github/workflows/deploy.yml'
      - 'index.html'
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install pygbag
      run: python -m pip install pygbag

    - name: Determine Changed Files
      id: changes
      run: |
        git fetch origin main
        echo "CHANGED_FILES=$(git diff --name-only HEAD origin/main)" >> $GITHUB_ENV

    - name: Build and Deploy App 1
      if: contains(env.CHANGED_FILES, 'app1/')
      run: |
        echo "Building App 1..."
        python -m pygbag --template $GITHUB_WORKSPACE/pygbag/template.tmpl --build $GITHUB_WORKSPACE/app1/main.py --output $GITHUB_WORKSPACE/build/app1
        echo "App 1 built."

    # Commented out fetching and building App 2
    # - name: Fetch App 2 Repository
    #   if: contains(env.CHANGED_FILES, 'app2/')
    #   run: |
    #     git clone https://github.com/username/app2-repo.git $GITHUB_WORKSPACE/app2

    # - name: Build and Deploy App 2
    #   if: contains(env.CHANGED_FILES, 'app2/')
    #   run: |
    #     echo "Building App 2..."
    #     python -m pygbag --template $GITHUB_WORKSPACE/pygbag/template.tmpl --build $GITHUB_WORKSPACE/app2/main.py --output $GITHUB_WORKSPACE/build/app2
    #     echo "App 2 built."

    - name: Copy Landing Page
      run: cp $GITHUB_WORKSPACE/index.html $GITHUB_WORKSPACE/build

    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: gh-pages
        folder: build
